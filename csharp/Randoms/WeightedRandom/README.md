### 负载均衡中随机策略和随机权重策略的区别


- 纯随机策略：
   在纯随机策略中，每个节点被选中的概率确实是相等的。对于三个节点，每个节点被选中的概率都是1/3。这种策略简单，但不考虑节点的性能差异。
- 随机权重策略：
   随机权重策略考虑了每个节点的权重，使得权重较高的节点有更高的概率被选中。这种策略既保留了一定的随机性，又能根据节点的性能来分配流量。

举个例子：

假设我们有三个节点，它们的权重分别是：

- 节点A：权重 100
- 节点B：权重 80
- 节点C：权重 60

总权重 = 100 + 80 + 60 = 240

在随机权重策略中：

- 节点A被选中的概率 = 100 / 240 ≈ 41.7%
- 节点B被选中的概率 = 80 / 240 ≈ 33.3%
- 节点C被选中的概率 = 60 / 240 = 25%

实现方式如下：

1. 生成一个0到总权重之间的随机数（`[0,1] * 总权重`）。
2. 按顺序累加每个节点的权重，直到累加和大于或等于随机数。
3. 选择导致累加和超过随机数的那个节点。

核心代码如下：

```c#
public T Select()
{
	double totalWeight = _itemWeights.Values.Sum();
	double randomWeight = _random.NextDouble() * totalWeight;
	double weightSum = 0;

	foreach (var item in _itemWeights)
	{
		weightSum += item.Value;
		if (randomWeight <= weightSum)
		{
			return item.Key;
		}
	}

	throw new InvalidOperationException("No item selected");
}
```

我们可以把它想象成一个大的饼图，每个节点占据一部分，面积大小与其权重成正比。然后我们随机地在这个饼图上扔一个飞镖，落在哪个区域就选择哪个节点。

随机权重的优点是：

1. 它考虑了节点的性能差异（通过权重反映）。
2. 它保留了一定的随机性，避免了总是选择同一个节点。
3. 它允许我们根据节点的实时性能动态调整权重。

特别是实现自适应负载均衡器中，我们首先根据各种指标给节点打分，然后用这个分数来调整节点的权重。这样，性能好的节点会获得更高的权重，从而在随机选择过程中有更高的概率被选中。

这种方法比纯随机策略更有效，因为它能够将更多的流量引导到性能较好的节点，同时又不会完全排除性能较差的节点，给了它们恢复的机会。